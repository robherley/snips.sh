name: Database Check

on:
  pull_request:
    paths:
      - 'internal/db/migrations/*.sql'

permissions:
  contents: read
  pull-requests: write

jobs:
  migrations:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - uses: actions/setup-go@v6
      with:
        go-version-file: go.mod
    - name: List changed migrations
      env:
        BASE_REF: ${{ github.base_ref }}
      run: |
        echo '<!-- migration-check-comment -->' >> diff-output.md
        echo '## Migration Changes' >> diff-output.md
        echo '' >> diff-output.md
        echo 'Changed migration files:' >> diff-output.md
        echo '```' >> diff-output.md
        git diff --name-only "origin/${BASE_REF}...HEAD" -- 'internal/db/migrations/*.sql' >> diff-output.md
        echo '```' >> diff-output.md
    - name: Add comment and label
      uses: actions/github-script@v8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const marker = '<!-- migration-check-comment -->';
          const body = fs.readFileSync('diff-output.md', {encoding:'utf8'});

          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });

          const existing = comments.find(c => c.body.includes(marker));

          if (existing) {
            await github.rest.issues.updateComment({
              comment_id: existing.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
          }

          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['migration']
          });
