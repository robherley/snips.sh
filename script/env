#!/usr/bin/env bash
# Source this file to set CGO/linker flags for ONNX runtime
# Usage: source script/env
#
# Environment variables:
#   ONNX_DIR - Override the ONNX runtime directory (default: third_party/onnxruntime)

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo ".")"

if [ -z "${ONNX_DIR:-}" ]; then
    ONNX_DIR="${REPO_ROOT}/third_party/onnxruntime"
fi

if [ ! -d "${ONNX_DIR}" ]; then
    echo "Error: ONNX runtime not found at ${ONNX_DIR}" >&2
    echo "Run: script/vendor-onnxruntime" >&2
    return 1 2>/dev/null || exit 1
fi

export CGO_ENABLED=1
export CGO_CFLAGS="-I${ONNX_DIR}/include"

case "$(uname -s)" in
    Darwin)
        export CGO_LDFLAGS="-L${ONNX_DIR}/lib -lonnxruntime"
        export DYLD_LIBRARY_PATH="${ONNX_DIR}/lib${DYLD_LIBRARY_PATH:+:${DYLD_LIBRARY_PATH}}"
        export GO_EXTLDFLAGS="-Wl,-rpath,${ONNX_DIR}/lib -Wl,-no_warn_duplicate_libraries"
        ;;
    Linux)
        export CGO_LDFLAGS="-L${ONNX_DIR}/lib -lonnxruntime"
        export LD_LIBRARY_PATH="${ONNX_DIR}/lib${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"
        export GO_EXTLDFLAGS="-Wl,-rpath,${ONNX_DIR}/lib"
        ;;
    *)
        export CGO_LDFLAGS="-L${ONNX_DIR}/lib -lonnxruntime"
        export GO_EXTLDFLAGS=""
        ;;
esac

# Write to GITHUB_ENV for use by subsequent steps in GitHub Actions
if [ -n "${GITHUB_ENV:-}" ]; then
    {
        echo "CGO_ENABLED=${CGO_ENABLED}"
        echo "CGO_CFLAGS=${CGO_CFLAGS}"
        echo "CGO_LDFLAGS=${CGO_LDFLAGS}"
        echo "GO_EXTLDFLAGS=${GO_EXTLDFLAGS}"
        case "$(uname -s)" in
            Darwin) echo "DYLD_LIBRARY_PATH=${DYLD_LIBRARY_PATH}" ;;
            Linux)  echo "LD_LIBRARY_PATH=${LD_LIBRARY_PATH}" ;;
        esac
    } >> "${GITHUB_ENV}"
fi

if [ -n "${VERBOSE:-}" ]; then
    echo "Environment configured:"
    echo "  CGO_ENABLED=${CGO_ENABLED}"
    echo "  CGO_CFLAGS=${CGO_CFLAGS}"
    echo "  CGO_LDFLAGS=${CGO_LDFLAGS}"
    echo "  GO_EXTLDFLAGS=${GO_EXTLDFLAGS}"
    case "$(uname -s)" in
        Darwin) echo "  DYLD_LIBRARY_PATH=${DYLD_LIBRARY_PATH}" ;;
        Linux)  echo "  LD_LIBRARY_PATH=${LD_LIBRARY_PATH}" ;;
    esac
fi
